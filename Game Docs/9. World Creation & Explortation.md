Needs to be completely rewritten